<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliação de Salvamento Veicular CFSd 2025</title>
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#DC2626',
                        'secondary': '#FBBF24',
                        'bg-dark': '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .container-main { min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 1rem; background-color: #F3F4F6; }
        .card { width: 100%; max-width: 800px; background: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        #individual-scores-table-print { display: none; }
        .detail-row { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; }
        .detail-row.open { max-height: 5000px; padding: 1rem 0; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .stat-card { background: white; border: 1px solid #e5e7eb; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        @media print {
            .no-print, #sync-status-bar, button, .print-hidden { display: none !important; }
            .card { box-shadow: none; padding: 0; max-width: 100%; }
            #form-view, #report-view, #dashboard-view { display: block !important; }
            .print-view-only { display: block !important; }
            #individual-scores-table { display: none !important; }
            #individual-scores-table-print { display: block !important; margin-top: 1rem; border-top: 1px solid #ccc; }
        }
    </style>
</head>
<body class="font-sans text-gray-900">

<div id="loading-db" class="loading-overlay" style="display: none;">
    <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-2"></div>
        <p class="text-xs font-bold text-gray-500 uppercase tracking-widest text-center">Processando Dados...</p>
    </div>
</div>

<div id="app" class="container-main">
    <div class="card">
        <!-- Status Bar -->
        <div id="sync-status-bar" class="mb-4 hidden no-print">
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 text-[10px] flex justify-between items-center rounded-lg">
                <p class="font-bold uppercase tracking-tighter">
                    ⚠️ <span id="pending-count">0</span> avaliações locais pendentes
                </p>
                <button onclick="processPendingSync()" class="bg-yellow-600 text-white px-3 py-1 rounded font-black">SINCRONIZAR</button>
            </div>
        </div>

        <h1 class="text-3xl font-black mb-6 text-center text-primary uppercase tracking-tighter no-print">Avaliação CFSd 2025</h1>
        
        <div id="main-content">
            <!-- List View -->
            <div id="list-view">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold text-gray-700 tracking-tight uppercase">Registros</h2>
                    <div class="flex items-center space-x-2">
                        <span id="connection-dot" class="h-2 w-2 rounded-full bg-green-500"></span>
                        <span class="text-[9px] font-black uppercase text-gray-400">Sistema Ativo</span>
                    </div>
                </div>
                
                <div class="mb-6 no-print">
                    <label for="evaluation-type-select" class="block text-[10px] font-black text-gray-400 mb-1 uppercase">Categoria de Prova:</label>
                    <select id="evaluation-type-select" onchange="renderEvaluationsList()" class="block w-full rounded-lg border-gray-300 p-3 border text-lg font-bold text-gray-700 bg-gray-50">
                        <option value="estabilizacao">1. Estabilização Veicular (3.0 pts)</option>
                        <option value="retirada">2. Retirada de Vítimas (3.0 pts)</option>
                        <option value="corte">3. Técnica de Corte (2.0 pts)</option>
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 mb-4 no-print">
                    <button onclick="showForm()" class="flex-1 py-4 bg-primary text-white font-black rounded-lg uppercase shadow-lg">+ Nova Avaliação</button>
                    <button onclick="showReportView('individual')" class="flex-1 py-4 bg-yellow-600 text-white font-black rounded-lg shadow-md">Histórico Militar</button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 mb-6 no-print">
                    <button onclick="showDashboardView()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md">Painel Gerencial</button>
                    <button onclick="showReportView('global')" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md">Quadro de Notas</button>
                </div>
                
                <div id="evaluations-list" class="space-y-3"></div>
                <div id="list-empty" class="text-center py-10 text-gray-400 border-2 border-dashed rounded-xl" style="display:none;">Nenhum registro encontrado.</div>
            </div>

            <!-- Form View -->
            <div id="form-view" style="display:none;">
                <h2 id="form-title" class="text-2xl font-black mb-4 text-gray-800 border-b pb-2 uppercase tracking-tighter no-print">Avaliação</h2>
                <form id="evaluation-form" class="space-y-4">
                    <input type="hidden" id="evaluation-id">
                    <input type="hidden" id="evaluation-type">

                    <div class="no-print">
                        <label for="evaluation-turma" class="block text-[10px] font-black text-gray-400 mb-2 uppercase">Turma:</label>
                        <select id="evaluation-turma" required onchange="handleTurmaChange()" class="block w-full rounded-lg border-gray-300 p-3 border text-sm font-black uppercase text-gray-700 bg-white shadow-inner">
                            <option value="">-- Selecione a Turma --</option>
                            <option value="ALFA">ALFA</option>
                            <option value="BRAVO">BRAVO</option>
                            <option value="CHARLIE">CHARLIE</option>
                            <option value="DELTA">DELTA</option>
                            <option value="ECHO">ECHO</option>
                            <option value="FOXTROT">FOXTROT</option>
                            <option value="GOLF">GOLF</option>
                            <option value="HOTEL">HOTEL</option>
                            <option value="INDIAN">INDIAN</option>
                            <option value="JULIET">JULIET</option>
                        </select>
                    </div>

                    <div class="no-print border-t pt-4">
                        <label class="block text-[10px] font-black text-gray-400 mb-2 uppercase">Equipe Avaliada:</label>
                        <div id="students-container" class="space-y-2 mb-3"></div>
                        <div id="student-helper-text" class="text-[10px] bg-gray-50 border p-2 rounded text-gray-500 italic mb-2">Selecione uma turma primeiro.</div>
                        <button type="button" onclick="addStudentInput()" class="w-full py-2 border border-dashed text-gray-500 rounded-lg text-xs font-bold uppercase tracking-tighter">+ Adicionar Militar na Equipe</button>
                    </div>

                    <div class="no-print border-t pt-4">
                        <label class="block text-[10px] font-black text-gray-400 mb-2 uppercase">Instrutores / Avaliadores:</label>
                        <div id="instructors-container" class="space-y-2 mb-3"></div>
                        <button type="button" onclick="addInstructorInput()" class="w-full py-2 border border-dashed text-gray-500 rounded-lg text-xs font-bold uppercase tracking-tighter">+ Adicionar Instrutor</button>
                    </div>

                    <div id="print-data-container" class="space-y-2 mb-4 print-view-only"></div>
                    
                    <div id="estabilizacao-subtype-container" style="display: none;" class="no-print">
                        <label class="block text-xs font-black text-gray-400 mb-1 uppercase">Cenário Estabilização:</label>
                        <select id="estabilizacao-subtype-select" onchange="renderPenaltiesRegistration()" class="block w-full rounded-lg border-gray-300 p-3 border text-sm font-black uppercase bg-white"><option value="4rodas">4 Rodas</option><option value="tombado">Tombado</option></select>
                    </div>
                    <div id="corte-subtype-container" style="display: none;" class="no-print">
                        <label class="block text-xs font-black text-gray-400 mb-1 uppercase">Técnica Corte:</label>
                        <select id="corte-subtype-select" onchange="renderPenaltiesRegistration()" class="block w-full rounded-lg border-gray-300 p-3 border text-sm font-black uppercase bg-white"><option value="painel">Rebatimento Painel</option><option value="teto">Rebatimento Teto</option></select>
                    </div>

                    <div id="time-selector-container" class="no-print">
                        <label class="block text-sm font-black text-gray-700 mb-1 uppercase">Tempo de Execução:</label>
                        <div class="flex space-x-3 items-end">
                            <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold uppercase">Mins</label><select id="time-minutes" onchange="calculateScores()" class="block w-full rounded-lg border-gray-300 p-3 border font-mono font-bold bg-white"></select></div>
                            <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold uppercase">Segs</label><select id="time-seconds" onchange="calculateScores()" class="block w-full rounded-lg border-gray-300 p-3 border font-mono font-bold bg-white"></select></div>
                            <div class="w-1/4"><label class="text-[10px] text-gray-400 font-bold uppercase">ms</label><input type="number" id="time-milliseconds" oninput="calculateScores()" min="0" max="999" value="000" class="block w-full rounded-lg border-gray-300 p-3 border text-center font-mono font-bold bg-white"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 font-bold italic">Nota Base: <span id="base-score" class="text-primary font-black">0.0</span></p>
                    </div>

                    <h3 class="text-sm font-black pt-4 text-gray-800 no-print uppercase tracking-widest">Barema Técnico</h3>
                    <div id="penalties-registration-list" class="space-y-4 p-4 border rounded-lg bg-gray-50 no-print"></div>
                    <div id="penalties-summary" class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 shadow-inner">
                        <h4 class="font-black mb-3 uppercase text-[10px] tracking-widest border-b border-yellow-200 pb-1">Espelho de Ocorrências:</h4>
                        <ul id="penalty-breakdown" class="space-y-3"></ul>
                    </div>
                    
                    <div class="pt-6 border-t-2 mt-6 border-gray-200">
                        <div class="flex justify-between items-center mb-4 p-4 bg-gray-100 rounded-lg shadow-inner no-print">
                            <span class="text-xs font-bold text-gray-500 uppercase">Soma de Penalidades:</span>
                            <span id="penalty-count" class="text-2xl font-black text-primary">0</span>
                        </div>
                        <h3 class="text-xl font-bold mb-3 text-gray-800 text-center uppercase">Resultados Finais</h3>
                        <div id="individual-scores-table" class="space-y-2"></div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 mt-6 no-print">
                        <button type="submit" class="flex-1 py-4 bg-green-600 text-white font-black rounded-lg uppercase shadow-lg">Salvar Avaliação</button>
                        <button type="button" onclick="showList()" class="flex-1 py-4 bg-gray-500 text-white font-black rounded-lg uppercase">Sair</button>
                    </div>
                </form>
            </div>

            <!-- Relatórios -->
            <div id="report-view" style="display:none;">
                <h2 id="report-title" class="text-2xl font-black mb-4 border-b pb-2 uppercase text-primary no-print">Relatório</h2>
                <div id="report-selection-container" class="no-print mb-4 flex flex-col gap-2"></div>
                <div id="student-report-output" class="mt-4"></div>
                <div class="flex gap-2 no-print">
                    <button onclick="window.print()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg uppercase mt-6 shadow-md">Gerar PDF / Imprimir</button>
                    <button onclick="showList()" class="flex-1 py-3 bg-gray-500 text-white font-bold rounded-lg mt-6 uppercase shadow-md">Voltar</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard-view" style="display:none;">
                <h2 class="text-2xl font-black mb-6 text-primary uppercase border-b pb-2 no-print">Painel Gerencial</h2>
                <div class="space-y-6">
                    <div class="stat-card border-l-4 border-indigo-500">
                        <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest font-bold">Desempenho por Turma (%)</h3>
                        <div id="dash-turma-stats" class="space-y-4"></div>
                    </div>
                    <div class="stat-card border-l-4 border-primary">
                        <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest font-bold">Nota Média por Tipo de Prova</h3>
                        <div id="dash-prova-stats" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
                    </div>
                    <div class="stat-card border-l-4 border-yellow-500">
                        <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest font-bold">Top 10 Penalidades (Ocorrências)</h3>
                        <div id="dash-penalty-stats" class="space-y-2"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 my-8 text-center no-print">
                    <div class="stat-card"><p class="text-[10px] font-black text-gray-400 uppercase">Avaliações</p><p id="dash-total-evals" class="text-3xl font-black text-primary">0</p></div>
                    <div class="stat-card"><p class="text-[10px] font-black text-gray-400 uppercase">Militares</p><p id="dash-total-militares" class="text-3xl font-black text-blue-600">0</p></div>
                    <div class="stat-card"><p class="text-[10px] font-black text-gray-400 uppercase">Aproveitamento</p><p id="dash-pass-rate" class="text-3xl font-black text-green-500">0%</p></div>
                    <div class="stat-card"><p class="text-[10px] font-black text-gray-400 uppercase">Categorias</p><p id="dash-total-types" class="text-3xl font-black text-orange-500">3</p></div>
                </div>
                <div class="flex gap-2 no-print">
                    <button onclick="window.print()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg uppercase shadow-md">Imprimir Painel</button>
                    <button onclick="showList()" class="flex-1 py-3 bg-gray-500 text-white font-black rounded-lg uppercase shadow-md">Voltar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONSTANTES E CONFIGURAÇÕES ---
    const TURMAS_ORDER = ['ALFA', 'BRAVO', 'CHARLIE', 'DELTA', 'ECHO', 'FOXTROT', 'GOLF', 'HOTEL', 'INDIAN', 'JULIET'];
    
    // TABELA ESTABILIZAÇÃO (1,5 PTS)
    const TIME_SCORES_1_5 = [
        {max: 90.00, s: 1.5}, {max: 99.999, s: 1.4}, {max: 109.999, s: 1.3}, {max: 119.999, s: 1.2}, 
        {max: 129.999, s: 1.1}, {max: 139.999, s: 1.0}, {max: 149.999, s: 0.9}, {max: 159.999, s: 0.8}, 
        {max: 169.999, s: 0.7}, {max: 179.999, s: 0.6}, {max: 189.999, s: 0.5}, {max: 199.999, s: 0.4}, 
        {max: 209.999, s: 0.3}, {max: 219.999, s: 0.2}, {max: 229.999, s: 0.1}, {max: Infinity, s: 0.0}
    ];

    // TABELA RETIRADA (3,0 PTS) - CORRIGIDA CONFORME PDF
    const TIME_SCORES_3_0 = [
        {max: 300.00, s: 3.0},   // Até 5'00"
        {max: 309.999, s: 2.8},  // 5'00"01 a 5'09"99
        {max: 319.999, s: 2.6},  // 5'10" a 5'19"99
        {max: 329.999, s: 2.4},  // 5'20" a 5'29"99
        {max: 339.999, s: 2.2},  // 5'30" a 5'39"99
        {max: 349.999, s: 2.0},  // 5'40" a 5'49"99
        {max: 359.999, s: 1.8},  // 5'50" a 5'59"99
        {max: 369.999, s: 1.6},  // 6'00" a 6'09"99
        {max: 379.999, s: 1.4},  // 6'10" a 6'19"99
        {max: 389.999, s: 1.2},  // 6'20" a 6'29"99
        {max: 399.999, s: 1.0},  // 6'30" a 6'39"99
        {max: 409.999, s: 0.8},  // 6'40" a 6'49"99
        {max: 419.999, s: 0.6},  // 6'50" a 6'59"99
        {max: 429.999, s: 0.4},  // 7'00" a 7'09"99
        {max: 439.999, s: 0.2},  // 7'10" a 7'19"99
        {max: Infinity, s: 0.0}   // Acima de 7'20"
    ];
    
    const EVAL_CONFIGS = {
        'estabilizacao': { 
            name: 'Estabilização Veicular', 
            short_name: 'Estabilização', 
            base_score: 1.5, 
            penalty_deduction: 0.2, 
            is_timed_score: true, 
            is_estabilizacao: true,
            penalties: [
                "Utilizar calço não previsto para a finalidade e em local não previsto na estabilização",
                "Utilizar o conjunto de escoras de maneira incorreta segundo o manual do fabricante ou ensinado nas aulas",
                "Colocar-se em situação insegura durante a realização da estabilização veicular",
                "Utilizar o conjunto de V-Strut de maneira incorreta segundo o manual do fabricante ou ensinado nas aulas",
                "Não travar a catraca do V-Strut",
                "Qualquer outro procedimento errado",
                "O calço ficar solto ou mal colocado (retirar 0,2 para cada calço)"
            ]
        },
        'retirada': { 
            name: 'Retirada de Vítimas', 
            short_name: 'Retirada Vítimas', 
            base_score: 3.0, 
            penalty_deduction: 0.3, 
            is_timed_score: true, 
            is_estabilizacao: false,
            penalties: [
                "Não realizar corretamente a estabilização veicular",
                "Não realizar a avaliação 360 graus no veículo (andando)",
                "Não realizar abordagem de frente para a vítima",
                "Não realizar os procedimentos internos (desligar o veículo, acionar o freio estacionário)",
                "Entrar no veículo antes da estabilização",
                "Não imobilizar a vítima de maneira correta (deixar a cervical solta, movimentos inadequados, etc.)",
                "Realizar a retirada da vítima com técnica diversa a de 30 graus",
                "Não colocar o O2 (oxigênio)",
                "Não colocar o oxímetro",
                "Não colocar o colar cervical",
                "Não cobrir a vítima",
                "Não cobrir a vítima antes de abrir o desencarcerador (simulação)",
                "Não tirar a luva de vaqueta ao tocar na vítima",
                "Procedimento inseguro para a vítima ou membros da equipe",
                "Retirada descoordenada ou movimentação desnecessária da vítima",
                "Qualquer outro procedimento divergente ao ensinado nas aulas ou errado"
            ]
        },
        'corte': { 
            name: 'Técnica de Corte', 
            short_name: 'Técnica Corte', 
            base_score: 2.0, 
            penalty_deduction: 0.1, 
            is_timed_score: false, 
            is_estabilizacao: false, 
            is_corte: true,
            penalties: {
                'painel': [
                    "01. Abertura da porta (dobradiças) - usar alargador",
                    "02. Abertura da porta (fechadura) - usar alargador",
                    "03. Corte da coluna A na parte mediana - usar cortador",
                    "04. Corte de alívio na base da coluna A - usar cortador",
                    "05. Posicionar o apoio do extensor e abrir até atingir a coluna A alta",
                    "Qualquer procedimento incorreto ou não previsto no rebatimento de painel"
                ],
                'teto': [
                    "01. Corte da Coluna A superior - usar cortador",
                    "02. Corte da Coluna B superior - usar cortador",
                    "03. Corte da coluna C e D superior - usar cortador",
                    "04. Corte do vidro dianteiro - usar machadinha e/ou serra sabre",
                    "05. 02 Cortes de alívio no teto perto da Coluna A e D - usar cortador",
                    "Qualquer procedimento incorreto ou não previsto no rebatimento de teto"
                ]
            }
        }
    };

    const LOCAL_ALUNOS_KEY = 'offline_bombeiros_alunos';
    const PENDING_SYNC_KEY = 'pending_sync_avaliacoes';
    const supabaseClient = supabase.createClient('https://mnpnwmprnantdyqdtfef.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ucG53bXBybmFudGR5cWR0ZmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMDcyOTcsImV4cCI6MjA4MTU4MzI5N30.f0Hg4ovkXmNUoqbC9nrFwhurPjJ9pnwJYYTtH20g-NM');

    // --- 2. ESTADO GLOBAL ---
    let cachedEvaluations = [];
    let cachedAlunos = [];
    let studentPenalties = {};
    let allStudentsInAllEvaluations = [];

    // --- 3. FUNÇÕES (HOISTING NOMINAL) ---

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }
    function timeObjectToString(obj) { return `${String(obj.minutes || 0).padStart(2, '0')}:${String(obj.seconds || 0).padStart(2, '0')}.${String(obj.milliseconds || 0).padStart(3, '0')}`; }
    function getCurrentEvaluationConfig(type) { return EVAL_CONFIGS[type] || EVAL_CONFIGS['estabilizacao']; }
    
    function getFriendlySubtypeName(type, subtype) {
        if (!subtype) return '';
        if (type === 'estabilizacao') return subtype === '4rodas' ? '4 Rodas' : 'Tombado';
        if (type === 'corte') return subtype === 'painel' ? 'Painel' : 'Teto';
        return subtype;
    }

    function timeStringToObjects(timeStr) {
        if (!timeStr || !timeStr.includes(':')) return { minutes: 0, seconds: 0, milliseconds: 0 };
        const parts = timeStr.split(':');
        const rest = parts[1] || '00.000';
        const restParts = rest.split('.');
        return { minutes: parseInt(parts[0]) || 0, seconds: parseInt(restParts[0]) || 0, milliseconds: parseInt(restParts[1]) || 0 };
    }

    function getFlexibleVal(obj, searchKey) {
        if (!obj) return null;
        const normSearch = searchKey.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");
        const actualKey = Object.keys(obj).find(k => k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "") === normSearch);
        return actualKey ? obj[actualKey] : null;
    }

    function getStudentNamesFromForm() { return Array.from(document.querySelectorAll('.student-name-input')).map(i => i.value.trim()).filter(v => v); }
    function getInstructorNamesFromForm() { return Array.from(document.querySelectorAll('.instructor-name-input')).map(i => i.value.trim()).filter(v => v); }

    function populateTimeSelectors() {
        const mins = document.getElementById('time-minutes');
        const secs = document.getElementById('time-seconds');
        if (!mins || !secs) return;
        mins.innerHTML = ''; secs.innerHTML = '';
        for (let i = 0; i <= 15; i++) {
            const opt = document.createElement('option'); opt.value = i; opt.textContent = String(i).padStart(2, '0');
            mins.appendChild(opt);
        }
        for (let i = 0; i < 60; i++) {
            const opt = document.createElement('option'); opt.value = i; opt.textContent = String(i).padStart(2, '0');
            secs.appendChild(opt);
        }
    }

    function getTimeBaseScore(seconds) {
        const typeEl = document.getElementById('evaluation-type');
        if (!typeEl) return 0;
        const type = typeEl.value;
        const config = getCurrentEvaluationConfig(type);
        if (!config.is_timed_score) return config.base_score;
        const list = (type === 'estabilizacao') ? TIME_SCORES_1_5 : TIME_SCORES_3_0;
        const scoreItem = list.find(t => seconds <= t.max);
        return scoreItem ? scoreItem.s : 0.0;
    }

    function updatePrintData() {
        const container = document.getElementById('print-data-container'); if (!container) return;
        const studs = getStudentNamesFromForm(); 
        const turma = document.getElementById('evaluation-turma').value;
        const type = document.getElementById('evaluation-type').value;
        const config = getCurrentEvaluationConfig(type);
        const mins = document.getElementById('time-minutes')?.value || 0;
        const secs = document.getElementById('time-seconds')?.value || 0;
        const ms = document.getElementById('time-milliseconds')?.value || 0;
        container.innerHTML = `<h3 class="text-lg font-bold border-b-2 border-primary pb-1 mb-2 uppercase text-primary italic">Avaliação CFSd 2025</h3><div class="grid grid-cols-2 text-[10px] italic font-medium"><p>Prova: ${config.name}</p><p>Turma: ${turma}</p><p>Tempo: ${config.is_timed_score ? timeObjectToString({minutes: mins, seconds: secs, milliseconds: ms}) : 'N/A'}</p><p class="col-span-2 border-t mt-1 pt-1 font-bold italic">Militares: ${studs.join(', ')}</p></div>`;
    }

    function calculateScores() {
        const typeEl = document.getElementById('evaluation-type'); if (!typeEl) return { scores: {}, timeStr: "00:00.000" };
        const type = typeEl.value; const config = getCurrentEvaluationConfig(type);
        const mins = parseInt(document.getElementById('time-minutes')?.value || 0);
        const secs = parseInt(document.getElementById('time-seconds')?.value || 0);
        const ms = parseInt(document.getElementById('time-milliseconds')?.value || 0);
        const totalSecs = (mins * 60) + secs + (ms / 1000);
        
        let bs = config.is_timed_score ? getTimeBaseScore(totalSecs) : config.base_score;
        const baseEl = document.getElementById('base-score'); if(baseEl) baseEl.textContent = bs.toFixed(1);

        const studs = getStudentNamesFromForm(); const table = document.getElementById('individual-scores-table'); if(table) table.innerHTML = ''; const sc = {};
        let totalP = 0; for (const r in studentPenalties) { for (const p in studentPenalties[r]) totalP += studentPenalties[r][p]; }
        const pCnt = document.getElementById('penalty-count'); if(pCnt) pCnt.textContent = totalP;
        
        const gDed = Object.values(studentPenalties["Grupo"] || {}).reduce((a,b) => a+b, 0);
        studs.forEach(s => {
            let pCount = gDed + Object.values(studentPenalties[s] || {}).reduce((a,b) => a+b, 0);
            let final = Math.max(0, bs - (pCount * config.penalty_deduction));
            sc[s] = { finalScore: final, penaltyCount: pCount };
            if(table) table.innerHTML += `<div class="flex justify-between p-3 border rounded-lg ${final >= (config.base_score * 0.7) ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} shadow-sm font-black text-[10px] uppercase"><span>${s}</span><span>${final.toFixed(1)}</span></div>`;
        });
        updatePrintData();
        return { scores: sc, timeStr: timeObjectToString({minutes: mins, seconds: secs, milliseconds: ms}) };
    }

    function renderPenaltyItemsList(ev, militar = null) {
        const config = getCurrentEvaluationConfig(ev.type);
        let src = config.penalties; if (config.is_corte && ev.subtype) src = config.penalties[ev.subtype];
        let h = '<ul class="mt-2 space-y-1">'; let content = false; const pens = ev.penalties || {};
        if (pens["Grupo"]) { 
            for (const pId in pens["Grupo"]) { 
                const idx = parseInt(pId.split('-')[1]);
                const text = Array.isArray(src) ? src[idx] : src[idx];
                h += `<li class="text-[10px] leading-tight"><span class="font-black text-primary text-[8px] uppercase">[Equipe]</span> ${text || 'Item'} (x${pens["Grupo"][pId]})</li>`; content = true; 
            } 
        }
        if (militar && pens[militar]) { 
            for (const pId in pens[militar]) { 
                const idx = parseInt(pId.split('-')[1]);
                const text = Array.isArray(src) ? src[idx] : src[idx];
                h += `<li class="text-[10px] leading-tight"><span class="font-black text-indigo-600 text-[8px] uppercase">[Indiv.]</span> ${text || 'Item'} (x${pens[militar][pId]})</li>`; content = true; 
            } 
        }
        return content ? h + '</ul>' : '<p class="text-[9px] text-green-600 italic font-bold">Limpo.</p>';
    }

    function applyPenalty(pId) {
        const sel = document.getElementById(`select-${pId}`);
        if (!sel || !sel.value) return;
        const resp = sel.value;
        if (!studentPenalties[resp]) studentPenalties[resp] = {};
        studentPenalties[resp][pId] = (studentPenalties[resp][pId] || 0) + 1;
        calculateScores(); renderPenaltyBreakdown();
    }

    function removePenalty(n, pId) {
        if (studentPenalties[n]?.[pId] > 0) {
            studentPenalties[n][pId]--;
            if (studentPenalties[n][pId] === 0) delete studentPenalties[n][pId];
            calculateScores(); renderPenaltyBreakdown();
        }
    }

    function renderPenaltyBreakdown() {
        const el = document.getElementById('penalty-breakdown'); if (!el) return;
        el.innerHTML = '';
        const type = document.getElementById('evaluation-type').value; 
        const config = getCurrentEvaluationConfig(type);
        let src = config.penalties; if (config.is_corte) src = config.penalties[document.getElementById('corte-subtype-select').value];
        Object.keys(studentPenalties).forEach(name => {
            const isG = name === "Grupo"; const cClass = isG ? "text-primary bg-primary/5" : "text-indigo-700 bg-indigo-50/50";
            let h = `<li class="mt-2 font-black p-1 border-l-4 ${cClass} text-[9px] uppercase tracking-tighter">${name}:</li><ul class="ml-4 space-y-1">`;
            let has = false;
            Object.keys(studentPenalties[name]).forEach(pId => {
                if (studentPenalties[name][pId] > 0) {
                    const idx = parseInt(pId.split('-')[1]);
                    const text = Array.isArray(src) ? src[idx] : 'Item';
                    h += `<li class="flex justify-between text-[10px] items-center leading-tight">${text} <span class="font-black ml-2 text-gray-400">x${studentPenalties[name][pId]}</span> <button type="button" onclick="removePenalty('${name}', '${pId}')" class="bg-red-50 text-white px-2 ml-2 rounded no-print">X</button></li>`;
                    has = true;
                }
            });
            if (has) el.innerHTML += h + '</ul>';
        });
    }

    function renderPenaltiesRegistration() {
        const cont = document.getElementById('penalties-registration-list'); if(!cont) return;
        const studs = getStudentNamesFromForm();
        const type = document.getElementById('evaluation-type').value || 'estabilizacao';
        const config = getCurrentEvaluationConfig(type);
        let list = config.is_corte ? config.penalties[document.getElementById('corte-subtype-select').value] : config.penalties;
        if (!Array.isArray(list)) list = [];
        
        cont.innerHTML = list.map((n, i) => `
            <div class="border-b pb-2">
                <p class="text-[11px] font-bold text-gray-700 leading-tight">${n}</p>
                <div class="flex space-x-2 mt-1">
                    <select id="select-p-${i}" class="flex-1 p-1 text-[10px] border rounded bg-white">
                        <option value="">-- Resp --</option>
                        <option value="Grupo" class="font-bold text-primary italic uppercase">EQUIPE</option>
                        ${studs.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                    <button type="button" onclick="applyPenalty('p-${i}')" class="bg-primary text-white px-4 py-1 rounded text-xs font-black shadow-sm transition hover:scale-105">+</button>
                </div>
            </div>`).join('');
        calculateScores();
    }

    function addStudentInput(name = '') {
        const container = document.getElementById('students-container'); if (!container) return;
        const selectedTurma = document.getElementById('evaluation-turma').value;
        const div = document.createElement('div'); div.className = "flex space-x-2";
        const filtered = cachedAlunos.filter(a => {
            const dbVal = (getFlexibleVal(a, "Turma") || "").toString().toUpperCase().trim();
            return dbVal === selectedTurma || dbVal === `TURMA ${selectedTurma}`;
        });
        if (selectedTurma && filtered.length > 0) {
            let opts = `<option value="">-- Selecionar Militar --</option>`;
            filtered.forEach(a => {
                const guerra = getFlexibleVal(a, "Nome de Guerra") || "Sd";
                const nbm = getFlexibleVal(a, "Nº BM") || "S/N";
                const text = `${nbm} - Sd 2 Cl ${guerra}`;
                opts += `<option value="${text}" ${name === text ? 'selected' : ''}>${text}</option>`;
            });
            div.innerHTML = `<select required onchange="renderPenaltiesRegistration()" class="flex-1 p-2 border border-gray-300 rounded-lg student-name-input uppercase text-[10px] font-black bg-white shadow-inner">${opts}</select><button type="button" onclick="this.parentElement.remove(); renderPenaltiesRegistration();" class="bg-red-500 text-white w-8 h-8 rounded-lg font-bold">✕</button>`;
        } else {
            div.innerHTML = `<input type="text" value="${name}" required placeholder="NOME MANUAL" oninput="renderPenaltiesRegistration()" class="flex-1 p-2 border border-gray-300 rounded-lg student-name-input uppercase text-xs font-black shadow-inner"><button type="button" onclick="this.parentElement.remove(); renderPenaltiesRegistration();" class="bg-red-500 text-white w-8 h-8 rounded-lg font-bold">✕</button>`;
        }
        container.appendChild(div);
        renderPenaltiesRegistration();
    }

    function addInstructorInput(name = '') {
        const container = document.getElementById('instructors-container'); if (!container) return;
        const div = document.createElement('div'); div.className = "flex space-x-2";
        div.innerHTML = `<input type="text" value="${name}" required placeholder="INSTRUTOR" class="flex-1 p-2 border border-gray-300 rounded-lg instructor-name-input uppercase text-xs font-black shadow-inner"><button type="button" onclick="this.parentElement.remove();" class="bg-red-500 text-white w-8 h-8 rounded-lg font-bold">✕</button>`;
        container.appendChild(div);
    }

    function handleTurmaChange() {
        const cont = document.getElementById('students-container'); if(cont) cont.innerHTML = '';
        const selectedTurma = document.getElementById('evaluation-turma').value;
        const helper = document.getElementById('student-helper-text');
        if (selectedTurma) {
            const filtered = cachedAlunos.filter(a => {
                const dbVal = (getFlexibleVal(a, "Turma") || "").toString().toUpperCase().trim();
                return dbVal === selectedTurma || dbVal === `TURMA ${selectedTurma}`;
            });
            if (filtered.length > 0) { if(helper) helper.innerHTML = `<span class="text-green-600 font-bold uppercase text-[9px]">${filtered.length} militares carregados.</span>`; addStudentInput(); }
            else { if(helper) helper.innerHTML = `<span class="text-red-500 font-bold uppercase text-[9px]">Offline / Cache vazio.</span>`; addStudentInput(); }
        }
    }

    async function deleteFromSupabase(id) {
        const overlay = document.getElementById('loading-db');
        if (overlay) overlay.style.display = 'flex';
        try {
            const { error } = await supabaseClient.from('avaliacoes').delete().eq('id', id);
            if (error) throw error;
        } catch (err) {
            console.error("Erro ao excluir:", err.message);
        } finally {
            if (overlay) overlay.style.display = 'none';
        }
    }

    function calculateDashboardMetrics() {
        const turmas = {}; const milSet = new Set(); const provas = {}; const penaltiesAgg = {};
        let passCount = 0; let totalPossibleItems = 0;
        cachedEvaluations.forEach(ev => {
            const config = getCurrentEvaluationConfig(ev.type);
            (ev.studentnames || []).forEach(n => milSet.add(n));
            if (!turmas[ev.turma]) turmas[ev.turma] = { earned: 0, possible: 0 };
            if (!provas[ev.type]) provas[ev.type] = { sum: 0, count: 0 };
            for (const name in ev.individualscores) {
                const score = ev.individualscores[name].finalScore;
                turmas[ev.turma].earned += score; turmas[ev.turma].possible += config.base_score;
                provas[ev.type].sum += score; provas[ev.type].count++;
                if (score >= (config.base_score * 0.7)) passCount++;
                totalPossibleItems++;
            }
            let src = config.penalties; if (config.is_corte && ev.subtype) src = config.penalties[ev.subtype];
            const pens = ev.penalties || {};
            for (const resp in pens) {
                for (const pId in pens[resp]) {
                    const idx = parseInt(pId.split('-')[1]);
                    const text = Array.isArray(src) ? src[idx] : 'Item';
                    const key = `[${config.short_name}] ${text}`;
                    penaltiesAgg[key] = (penaltiesAgg[key] || 0) + pens[resp][pId];
                }
            }
        });
        const tStats = document.getElementById('dash-turma-stats');
        if (tStats) {
            tStats.innerHTML = Object.keys(turmas).sort().map(t => {
                const perc = turmas[t].possible > 0 ? (turmas[t].earned / turmas[t].possible) * 100 : 0;
                return `<div><div class="flex justify-between text-[10px] font-black uppercase mb-1"><span>${t}</span><span class="text-indigo-600 font-black">${perc.toFixed(1)}%</span></div><div class="w-full bg-gray-100 h-2 rounded-full"><div class="bg-indigo-500 h-full transition-all duration-500" style="width: ${Math.min(perc, 100)}%"></div></div></div>`;
            }).join('') || '<p class="text-[10px] text-gray-400">Sem dados.</p>';
        }
        const pStats = document.getElementById('dash-prova-stats');
        if (pStats) {
            pStats.innerHTML = Object.keys(provas).map(type => {
                const avg = (provas[type].sum / provas[type].count).toFixed(2);
                return `<div class="bg-gray-50 p-3 rounded border text-center"><p class="text-[9px] font-black text-gray-400 uppercase mb-1">${getCurrentEvaluationConfig(type).short_name}</p><p class="text-xl font-black text-primary">${avg}</p></div>`;
            }).join('') || '<p class="text-[10px] text-gray-400">Sem dados.</p>';
        }
        const penStats = document.getElementById('dash-penalty-stats');
        if (penStats) {
            penStats.innerHTML = Object.entries(penaltiesAgg).sort((a,b) => b[1] - a[1]).slice(0, 10).map(([name, count]) => `<div class="flex justify-between items-center text-[10px] border-b pb-1"><span>${name}</span><span class="font-black text-primary bg-red-50 px-2 rounded-full">${count}x</span></div>`).join('') || '<p class="text-[10px] text-gray-400">Sem ocorrências.</p>';
        }
        const elE = document.getElementById('dash-total-evals'); if(elE) elE.textContent = cachedEvaluations.length;
        const elM = document.getElementById('dash-total-militares'); if(elM) elM.textContent = milSet.size;
        const elP = document.getElementById('dash-pass-rate'); if(elP) elP.textContent = totalPossibleItems > 0 ? Math.round((passCount / totalPossibleItems) * 100) + '%' : '0%';
    }

    async function syncData() {
        const overlay = document.getElementById('loading-db'); if (navigator.onLine) overlay.style.display = 'flex';
        try {
            const { data: dAlunos, error: eAlunos } = await supabaseClient.from('alunos').select('*');
            if (!eAlunos && dAlunos) { cachedAlunos = dAlunos; localStorage.setItem(LOCAL_ALUNOS_KEY, JSON.stringify(dAlunos)); } 
            else { const local = localStorage.getItem(LOCAL_ALUNOS_KEY); if (local) cachedAlunos = JSON.parse(local); }
            const { data: dEvals, error: eEvals } = await supabaseClient.from('avaliacoes').select('*');
            if (!eEvals) cachedEvaluations = dEvals || [];
            allStudentsInAllEvaluations = Array.from(new Set(cachedEvaluations.flatMap(e => e.studentnames || []))).sort();
            updateSyncStatus();
        } catch (err) { const local = localStorage.getItem(LOCAL_ALUNOS_KEY); if (local) cachedAlunos = JSON.parse(local); } finally { overlay.style.display = 'none'; }
    }

    function updateSyncStatus() {
        const pending = JSON.parse(localStorage.getItem(PENDING_SYNC_KEY) || "[]");
        const bar = document.getElementById('sync-status-bar');
        if (pending.length > 0) { bar.classList.remove('hidden'); document.getElementById('pending-count').textContent = pending.length; } else { bar.classList.add('hidden'); }
    }

    async function processPendingSync() {
        if (!navigator.onLine) return;
        const pending = JSON.parse(localStorage.getItem(PENDING_SYNC_KEY) || "[]"); if (pending.length === 0) return;
        const remaining = [];
        for (const item of pending) { try { await supabaseClient.from('avaliacoes').upsert(item); } catch (e) { remaining.push(item); } }
        localStorage.setItem(PENDING_SYNC_KEY, JSON.stringify(remaining)); if (remaining.length === 0) syncData();
    }

    async function saveEvaluation(evalData) {
        if (navigator.onLine) {
            const overlay = document.getElementById('loading-db'); overlay.style.display = 'flex';
            try { await supabaseClient.from('avaliacoes').upsert(evalData); return true; } catch (err) { console.warn("Offline."); } finally { overlay.style.display = 'none'; }
        }
        const pending = JSON.parse(localStorage.getItem(PENDING_SYNC_KEY) || "[]");
        const idx = pending.findIndex(p => p.id === evalData.id);
        if (idx > -1) pending[idx] = evalData; else pending.push(evalData);
        localStorage.setItem(PENDING_SYNC_KEY, JSON.stringify(pending)); return true;
    }

    // --- 4. MAPEAMENTO WINDOW FINAL ---
    window.applyPenalty = applyPenalty;
    window.removePenalty = removePenalty;
    window.renderPenaltiesRegistration = renderPenaltiesRegistration;
    window.calculateScores = calculateScores;
    window.addStudentInput = addStudentInput;
    window.addInstructorInput = addInstructorInput;
    window.updatePrintData = updatePrintData;
    window.handleTurmaChange = handleTurmaChange;
    window.getFriendlySubtypeName = getFriendlySubtypeName;
    window.getTimeBaseScore = getTimeBaseScore;
    window.getCurrentEvaluationConfig = getCurrentEvaluationConfig;
    window.renderPenaltyItemsList = renderPenaltyItemsList;
    window.populateTimeSelectors = populateTimeSelectors;

    window.deleteEvaluationInList = function(id) {
        if (confirm('Deseja excluir esta avaliação permanentemente?')) {
            deleteFromSupabase(id).then(() => {
                syncData().then(() => renderEvaluationsList());
            });
        }
    };

    window.showList = function() { syncData().then(() => { document.getElementById('form-view').style.display = 'none'; document.getElementById('report-view').style.display = 'none'; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('list-view').style.display = 'block'; renderEvaluationsList(); }); }
    window.showDashboardView = function() { syncData().then(() => { document.getElementById('list-view').style.display = 'none'; document.getElementById('dashboard-view').style.display = 'block'; calculateDashboardMetrics(); }); }

    window.showForm = function(id = null) {
        const ev = id ? cachedEvaluations.find(e => e.id === id) : null;
        const typeSelect = document.getElementById('evaluation-type-select');
        const type = ev ? ev.type : typeSelect.value;
        const config = getCurrentEvaluationConfig(type);
        document.getElementById('evaluation-type').value = type;
        document.getElementById('evaluation-id').value = ev?.id || '';
        document.getElementById('estabilizacao-subtype-container').style.display = config.is_estabilizacao ? 'block' : 'none';
        document.getElementById('corte-subtype-container').style.display = config.is_corte ? 'block' : 'none';
        
        // NOVIDADE: Oculta o seletor de tempo para provas sem nota por tempo (como Corte)
        document.getElementById('time-selector-container').style.display = config.is_timed_score ? 'block' : 'none';
        
        document.getElementById('evaluation-turma').value = ev?.turma || '';
        studentPenalties = ev?.penalties || {}; 
        document.getElementById('students-container').innerHTML = '';
        (ev?.studentnames || ['']).forEach(n => addStudentInput(n));
        document.getElementById('instructors-container').innerHTML = '';
        (ev?.instructornames || ['']).forEach(n => addInstructorInput(n));
        const t = timeStringToObjects(ev?.time || '00:00.000');
        document.getElementById('time-minutes').value = t.minutes; document.getElementById('time-seconds').value = t.seconds; document.getElementById('time-milliseconds').value = t.milliseconds;
        document.getElementById('list-view').style.display = 'none'; document.getElementById('form-view').style.display = 'block';
        renderPenaltiesRegistration(); renderPenaltyBreakdown();
    }

    function renderEvaluationsList() {
        const typeSelect = document.getElementById('evaluation-type-select'); if (!typeSelect) return;
        const evs = cachedEvaluations.filter(e => (e.type || 'estabilizacao') === typeSelect.value);
        const container = document.getElementById('evaluations-list'); container.innerHTML = '';
        if (evs.length === 0) { document.getElementById('list-empty').style.display = 'block'; return; }
        document.getElementById('list-empty').style.display = 'none';
        evs.sort((a,b) => new Date(b.updatedat) - new Date(a.updatedat)).forEach(ev => {
            const vals = Object.values(ev.individualscores || {}).map(s => s.finalScore);
            const range = vals.length ? (Math.min(...vals).toFixed(1) === Math.max(...vals).toFixed(1) ? Math.min(...vals).toFixed(1) : `${Math.min(...vals).toFixed(1)} - ${Math.max(...vals).toFixed(1)}`) : '0.0';
            container.innerHTML += `
                <div class="p-4 border rounded-xl bg-white flex justify-between items-center shadow-sm">
                    <div class="flex-1 pr-4">
                        <p class="text-[10px] text-primary font-black uppercase mb-1">${getFriendlySubtypeName(ev.type, ev.subtype) || 'Geral'} • ${ev.turma || 'S/T'}</p>
                        <p class="font-black text-gray-800 text-sm uppercase">${ev.studentnames[0]}${ev.studentnames.length > 1 ? ' + equipe' : ''}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="text-right">
                            <p class="text-[8px] uppercase font-black text-gray-400">Nota(s)</p>
                            <span class="text-lg font-black text-indigo-600">${range}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick='showForm("${ev.id}")' class="p-2 bg-gray-100 text-gray-600 rounded-lg shadow-sm hover:bg-secondary hover:text-white transition">✎</button>
                            <button onclick='deleteEvaluationInList("${ev.id}")' class="p-2 bg-gray-100 text-red-400 rounded-lg shadow-sm hover:bg-primary hover:text-white transition">✕</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    window.showReportView = function(type) {
        syncData().then(() => {
            document.getElementById('form-view').style.display = 'none'; document.getElementById('list-view').style.display = 'none'; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('report-view').style.display = 'block';
            const output = document.getElementById('student-report-output'); output.innerHTML = '';
            const selCont = document.getElementById('report-selection-container');
            if (type === 'individual') {
                document.getElementById('report-title').textContent = 'Ficha de Desempenho';
                selCont.innerHTML = `<select id="rep-stud" onchange="generateStudentReport()" class="w-full p-3 border rounded shadow-sm font-bold text-gray-700 bg-white"><option value="">-- Selecione o Militar --</option>${allStudentsInAllEvaluations.map(s => `<option value="${s}">${s}</option>`).join('')}</select>`;
            } else {
                document.getElementById('report-title').textContent = 'Quadro Geral de Notas';
                let turmaOptions = `<option value="TODAS">TODAS AS TURMAS</option>`;
                TURMAS_ORDER.forEach(t => turmaOptions += `<option value="${t}">${t}</option>`);
                selCont.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Filtrar Turma:</label>
                        <select id="rep-turma-filter" class="w-full p-3 border rounded shadow-sm font-bold text-gray-700 bg-white">
                            ${turmaOptions}
                        </select>
                        <button onclick="generateGlobalReport()" class="w-full py-4 bg-indigo-600 text-white rounded font-black uppercase text-xs shadow-md">Gerar Notas Detalhadas</button>
                    </div>`;
            }
        });
    }

    function generateGlobalReport() {
        const turmaFilter = document.getElementById('rep-turma-filter')?.value || 'TODAS';
        const sc = {}; 
        cachedEvaluations.forEach(ev => {
            if (turmaFilter !== 'TODAS' && ev.turma !== turmaFilter) return;
            for (const n in ev.individualscores) {
                const key = `${ev.turma}_${n}`; 
                if (!sc[key]) sc[key] = { name: n, turma: ev.turma, total: 0, evs: [] };
                sc[key].total += ev.individualscores[n].finalScore;
                sc[key].evs.push(ev);
            }
        });
        const sortedKeys = Object.keys(sc).sort((a, b) => {
            const idxA = TURMAS_ORDER.indexOf(sc[a].turma);
            const idxB = TURMAS_ORDER.indexOf(sc[b].turma);
            if (idxA !== idxB) return idxA - idxB;
            return sc[a].name.localeCompare(sc[b].name);
        });
        let h = '<div class="space-y-4">';
        sortedKeys.forEach(key => {
            const data = sc[key];
            h += `
                <div class="border rounded bg-white shadow-sm p-4">
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <div>
                            <span class="text-[8px] font-black bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded mr-2 uppercase">TURMA ${data.turma}</span>
                            <span class="font-bold text-sm uppercase">${data.name}</span>
                        </div>
                        <span class="text-2xl font-black text-indigo-600">${data.total.toFixed(1)}</span>
                    </div>
                    <div class="space-y-3">`;
            data.evs.forEach(ev => { 
                h += `
                <div class="p-2 bg-gray-50 rounded border">
                    <p class="text-[10px] font-bold uppercase text-primary">${getCurrentEvaluationConfig(ev.type).short_name} - Nota: ${ev.individualscores[data.name].finalScore.toFixed(1)}</p>
                    <div class="mt-1">${renderPenaltyItemsList(ev, data.name)}</div>
                </div>`; 
            });
            h += '</div></div>';
        });
        document.getElementById('student-report-output').innerHTML = h + '</div>';
    }

    function generateStudentReport() {
        const n = document.getElementById('rep-stud').value; if (!n) return;
        const evs = cachedEvaluations.filter(e => e.studentnames.includes(n));
        let sum = 0; let h = `<h3 class="font-black text-center border-b pb-3 mb-4 uppercase text-gray-700 tracking-widest text-lg">Histórico: ${n}</h3><div class="space-y-4">`;
        evs.sort((a, b) => new Date(b.updatedat) - new Date(a.updatedat)).forEach(ev => {
            const score = ev.individualscores[n].finalScore; sum += score;
            h += `<div class="p-4 border rounded-xl bg-gray-50 shadow-sm"><div class="flex justify-between mb-2 text-xs uppercase font-black"><span>${getCurrentEvaluationConfig(ev.type).name}</span><span>${ev.turma} | ${new Date(ev.updatedat).toLocaleDateString()}</span></div><div class="grid grid-cols-2 text-xs font-bold"><div><p class="text-[8px] text-gray-400">Tempo</p><p class="text-lg font-mono">${ev.time}</p></div><div class="text-right"><p class="text-[8px] text-gray-400">Nota</p><p class="text-2xl font-black text-primary">${score.toFixed(1)}</p></div></div><div class="mt-2 pt-2 border-t">${renderPenaltyItemsList(ev, n)}</div></div>`;
        });
        document.getElementById('student-report-output').innerHTML = `<div class="bg-indigo-600 text-white p-6 rounded-2xl text-center mb-6 shadow-lg"><p class="text-xs uppercase font-bold opacity-80 mb-1">Nota Total Acumulada</p><p class="text-5xl font-black">${sum.toFixed(1)} <span class="text-lg">pts</span></p></div>${h}</div>`;
    }

    window.generateGlobalReport = generateGlobalReport;
    window.generateStudentReport = generateStudentReport;
    
    document.getElementById('evaluation-form').onsubmit = async (e) => {
        e.preventDefault(); 
        const res = calculateScores(); 
        const type = document.getElementById('evaluation-type').value; 
        const config = getCurrentEvaluationConfig(type);
        let sub = undefined; if (config.is_corte) sub = document.getElementById('corte-subtype-select').value; if (config.is_estabilizacao) sub = document.getElementById('estabilizacao-subtype-select').value;
        const cleanedPenalties = {}; for (const resp in studentPenalties) { if (Object.keys(studentPenalties[resp]).length > 0) cleanedPenalties[resp] = studentPenalties[resp]; }
        const evalData = { id: document.getElementById('evaluation-id').value || generateId(), type, subtype: sub, turma: document.getElementById('evaluation-turma').value, studentnames: getStudentNamesFromForm(), instructornames: getInstructorNamesFromForm(), time: config.is_timed_score ? res.timeStr : "N/A", penalties: cleanedPenalties, individualscores: res.scores, updatedat: new Date().toISOString() };
        if (await saveEvaluation(evalData)) showList();
    };

    window.onload = async () => { 
        populateTimeSelectors(); 
        await syncData(); 
        renderEvaluationsList(); 
        document.getElementById('main-content').style.display = 'block'; 
    };
    window.addEventListener('online', () => { processPendingSync(); });
</script>

</body>
</html>