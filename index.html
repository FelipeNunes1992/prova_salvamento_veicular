<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliação de Salvamento Veicular CFSd 2025</title>
    <!-- Carregamento do Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#DC2626', // Vermelho forte
                        'secondary': '#FBBF24', // Amarelo
                        'bg-dark': '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .container-main {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
            background-color: #F3F4F6;
        }

        .card {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        
        .penalty-count-input::-webkit-outer-spin-button,
        .penalty-count-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .penalty-count-input {
            appearance: none;
            -moz-appearance: textfield; 
            border: none;
            background-color: transparent;
            font-size: 1.125rem;
        }

        #individual-scores-table-print {
            display: none;
        }

        .score-good { color: #10B981; font-weight: 700; }
        .score-bad { color: #DC2626; font-weight: 700; }
        
        .detail-row {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
            max-height: 0;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        .detail-row.open {
            max-height: 3000px; 
            margin-bottom: 1rem !important;
        }

        @media print {
            .no-print, #list-view, .flex-col > button, .space-x-2 button, .print-hidden, #report-selection-container {
                display: none !important;
            }
            .card { box-shadow: none; padding: 0; max-width: 100%; }
            #form-view { display: block !important; }
            #penalties-summary { background-color: #fff; border: 1px solid #ccc; }
            h1, h2, h3 { color: black !important; }
            .print-view-only { display: block !important; }
            #individual-scores-table { display: none !important; }
            #individual-scores-table-print {
                display: block !important;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #ccc;
            }
            .score-title-no-print { display: none !important; }
            #report-view .detail-row {
                max-height: none !important;
                overflow: visible !important;
                display: block !important;
            }
            #report-view { display: block !important; }
        }
    </style>
</head>
<body class="font-sans">

<div id="app" class="container-main">
    <div class="card">
        <h1 class="text-3xl font-bold mb-6 text-center text-primary uppercase tracking-tight">Avaliação Salvamento CFSd 2025</h1>
        <p id="auth-status" class="text-sm text-gray-500 mb-4 text-center no-print italic">Sistema Offline - Dados Locais</p> 
        <div id="loading-spinner" class="text-center py-12 no-print" style="display:none;"></div>
        
        <div id="main-content">
            <!-- LISTAGEM INICIAL -->
            <div id="list-view">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Avaliações Cadastradas</h2>
                
                <div class="mb-6 no-print">
                    <label for="evaluation-type-select" class="block text-sm font-medium text-gray-700 mb-1">Filtro de Prova:</label>
                    <select id="evaluation-type-select" onchange="renderEvaluationsList()" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border text-lg">
                        <option value="estabilizacao">1. Estabilização Veicular (3.0 pts)</option>
                        <option value="retirada">2. Retirada de Vítimas (3.0 pts)</option>
                        <option value="corte">3. Técnica de Corte (2.0 pts)</option>
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 mb-4 no-print">
                    <button onclick="showForm()" class="flex-1 py-3 bg-primary text-white font-bold rounded-lg hover:bg-red-700 transition duration-300 shadow-md uppercase text-sm tracking-widest">
                        + Nova Avaliação
                    </button>
                    <button onclick="showReportView('individual')" class="flex-1 py-3 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition duration-300 shadow-md text-sm uppercase tracking-widest">
                        Histórico por Aluno
                    </button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 mb-6 no-print">
                    <button id="export-csv-btn" onclick="exportToCSV()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300 shadow-md text-sm uppercase tracking-widest">
                        Exportar CSV
                    </button>
                    <button onclick="showReportView('global')" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-300 shadow-md text-sm uppercase tracking-widest">
                        Quadro Geral
                    </button>
                </div>
                
                <div id="evaluations-list" class="space-y-3"></div>
                
                <div id="list-empty" class="text-center py-10 text-gray-500" style="display:none;">
                    <p>Nenhuma avaliação encontrada. Clique em "Nova Avaliação" para começar.</p>
                </div>
            </div>

            <!-- FORMULÁRIO DE EDIÇÃO -->
            <div id="form-view" style="display:none;">
                <h2 id="form-title" class="text-2xl font-semibold mb-4 text-gray-800">Nova Avaliação</h2>
                <form id="evaluation-form" class="space-y-4">
                    <input type="hidden" id="evaluation-id">
                    <input type="hidden" id="evaluation-type">

                    <!-- Alunos -->
                    <div class="no-print">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alunos do Grupo/Equipe:</label>
                        <div id="students-container" class="space-y-2 mb-3"></div>
                        <button type="button" onclick="addStudentInput()" class="w-full py-2 border border-dashed border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition duration-150 text-sm">
                            + Adicionar Aluno
                        </button>
                    </div>

                    <!-- Avaliadores -->
                    <div class="no-print border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Avaliadores / Instrutores:</label>
                        <div id="instructors-container" class="space-y-2 mb-3"></div>
                        <button type="button" onclick="addInstructorInput()" class="w-full py-2 border border-dashed border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition duration-150 text-sm">
                            + Adicionar Avaliador
                        </button>
                    </div>

                    <div id="print-data-container" class="space-y-2 mb-4 print-view-only"></div>
                    
                    <!-- Sub-tipos -->
                    <div class="no-print" id="corte-subtype-container" style="display: none;">
                        <label for="corte-subtype-select" class="block text-sm font-medium text-gray-700 mb-1">Técnica Específica:</label>
                        <select id="corte-subtype-select" onchange="renderPenaltiesRegistration()" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border text-sm font-bold">
                            <option value="painel">Rebatimento de Painel</option>
                            <option value="teto">Rebatimento Lateral de Teto</option>
                        </select>
                    </div>
                    
                    <div class="no-print" id="estabilizacao-subtype-container" style="display: none;">
                        <label for="estabilizacao-subtype-select" class="block text-sm font-medium text-gray-700 mb-1">Cenário da Estabilização:</label>
                        <select id="estabilizacao-subtype-select" onchange="renderPenaltiesRegistration()" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border text-sm font-bold">
                            <option value="4rodas">Veículo Sobre 04 Rodas (1.5 pts)</option>
                            <option value="tombado">Veículo Tombado (1.5 pts)</option>
                        </select>
                    </div>

                    <!-- Tempo (Escondido se for Corte) -->
                    <div class="no-print" id="time-selector-container">
                        <label class="block text-sm font-medium text-gray-700 mb-1" id="time-label">Tempo de Execução:</label>
                        <div class="flex space-x-3 items-end">
                            <div class="flex-1">
                                <label for="time-minutes" class="text-xs text-gray-500">Minutos</label>
                                <select id="time-minutes" onchange="calculateScores()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border"></select>
                            </div>
                            <div class="flex-1">
                                <label for="time-seconds" class="text-xs text-gray-500">Segundos</label>
                                <select id="time-seconds" onchange="calculateScores()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border"></select>
                            </div>
                            <div class="w-1/4">
                                <label for="time-milliseconds" class="text-xs text-gray-500">ms</label>
                                <input type="number" id="time-milliseconds" oninput="calculateScores()" min="0" max="999" value="000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border text-center">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Nota Base (Tempo): <span id="base-score" class="font-semibold text-blue-600">0.0</span></p>
                    </div>

                    <!-- Penalidades -->
                    <h3 class="text-xl font-semibold pt-4 text-gray-800 no-print uppercase text-sm tracking-tighter" id="penalties-title">Registro de Penalidades</h3>
                    <div id="penalties-registration-list" class="space-y-4 p-4 border rounded-lg bg-gray-50 no-print"></div>
                    
                    <div id="penalties-summary" class="mt-6 p-4 bg-yellow-50 rounded-lg text-sm border border-yellow-200">
                        <h4 class="font-bold mb-3 text-gray-800 uppercase text-[10px] tracking-widest border-b pb-1">Espelho de Ocorrências:</h4>
                        <ul id="penalty-breakdown" class="space-y-3"></ul>
                    </div>
                    
                    <!-- Notas Individuais -->
                    <div class="pt-6 border-t mt-6 border-gray-200">
                        <div class="flex justify-between items-center mb-4 p-4 bg-gray-100 rounded-lg shadow-inner print-hidden">
                            <span class="text-lg font-bold text-gray-700 uppercase tracking-tighter">Ocorrências Totais (Equipe + Grupo):</span>
                            <span id="penalty-count" class="text-2xl font-extrabold text-primary">0</span>
                        </div>
                        <h3 class="text-xl font-bold mb-3 text-gray-800 score-title-no-print text-center uppercase tracking-tighter">Notas Finais Individuais</h3>
                        <div id="individual-scores-table" class="space-y-2"></div>
                        <div id="individual-scores-table-print" class="print-view-only"></div>
                    </div>

                    <!-- Ações -->
                    <div class="flex flex-col sm:flex-row gap-3 mt-6 no-print">
                        <button type="submit" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-300 shadow-md uppercase text-sm tracking-widest">Salvar Avaliação</button>
                        <button type="button" onclick="showList()" class="flex-1 py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300 shadow-md uppercase text-sm tracking-widest">Cancelar</button>
                    </div>
                    <button type="button" onclick="triggerPrint()" class="w-full py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition duration-300 shadow-md mt-3 no-print uppercase text-sm tracking-widest">Imprimir Barema</button>
                </form>
            </div>

            <!-- RELATÓRIOS -->
            <div id="report-view" style="display:none;">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800" id="report-title">Relatório</h2>
                <div id="report-selection-container" class="no-print"></div>
                <div id="student-report-output" class="space-y-4 p-4 border rounded-lg bg-white shadow-md mt-4"></div>
                <button onclick="showList()" class="w-full py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300 shadow-md mt-6 no-print text-sm uppercase font-bold tracking-widest">Voltar para Lista Principal</button>
            </div>
        </div>
    </div>
</div>

<script>
    const LOCAL_STORAGE_KEY = 'salvamento_avaliacoes';
    let studentPenalties = {}; 
    let studentCount = 0; 
    let instructorCount = 0;
    let allStudentsInAllEvaluations = [];
    
    const ESTABILIZACAO_PENALTIES = [
        "Utilizar calço não previsto para a finalidade e em local não previsto na estabilização",
        "Utilizar o conjunto de escoras de maneira incorreta segundo o manual do fabricante ou ensinado nas aulas",
        "Colocar-se em situação insegura durante a realização da estabilização veicular",
        "Qualquer outro procedimento errado",
        "O calço ficar solto ou mal colocado (retirar 0,2 para cada calço)",
    ];

    const COMMON_PENALTIES = [
        "Não realizar corretamente a estabilização veicular",
        "Não realizar a avaliação 360 graus no veículo (andando)",
        "Não realizar abordagem de frente para a vítima",
        "Não realizar os procedimentos internos (desligar o veículo, acionar o freio estacionário)",
        "Entrar no veículo antes da estabilização",
        "Não imobilizar a vítima de maneira correta",
        "Realizar a retirada da vítima com técnica diversa a de 30 graus",
        "Não colocar o O2",
        "Não colocar o oxímetro",
        "Não colocar o colar cervical",
        "Não cobrir a vítima",
        "Qualquer outro procedimento divergente ao ensinado nas aulas",
    ];

    const CORTE_SUBTYPE_PENALTIES = {
        'painel': [
            "01. Abertura da porta (dobradiças) – usar alargador",
            "02. Abertura da porta (fechadura) – usar alargador",
            "03. Corte da coluna A na parte mediana – usar cortador",
            "04. Corte de alívio na base da coluna A – usar cortador",
            "05. Posicionar o apoio do extensor (0.2 pts decréscimo)",
            "Qualquer procedimento incorreto / técnica não prevista"
        ],
        'teto': [
            "01. Corte da Coluna A superior – usar cortador",
            "02. Corte da Coluna B superior – usar cortador",
            "03. Corte da coluna C e D superior – usar cortador",
            "04. Corte do vidro dianteiro – usar machadinha e/ou serra sabre",
            "05. 2 Cortes de alívio no teto perto da Coluna A e D",
            "Qualquer procedimento incorreto / técnica não prevista"
        ]
    };

    const TIME_SCORES_1_5 = [
        { maxTime: 180, score: 1.5 }, { maxTime: 189.99, score: 1.4 }, { maxTime: 199.99, score: 1.3 },
        { maxTime: 209.99, score: 1.2 }, { maxTime: 219.99, score: 1.1 }, { maxTime: 229.99, score: 1.0 },
        { maxTime: 239.99, score: 0.9 }, { maxTime: 249.99, score: 0.8 }, { maxTime: 259.99, score: 0.7 },
        { maxTime: 269.99, score: 0.6 }, { maxTime: 279.99, score: 0.5 }, { maxTime: 289.99, score: 0.4 },
        { maxTime: 299.99, score: 0.3 }, { maxTime: 309.99, score: 0.2 }, { maxTime: 319.99, score: 0.1 },
        { maxTime: Infinity, score: 0.0 }
    ];
    
    const TIME_SCORES_3_0 = [
        { maxTime: 300, score: 3.0 }, { maxTime: 309.99, score: 2.8 }, { maxTime: 319.99, score: 2.6 },
        { maxTime: 329.99, score: 2.4 }, { maxTime: 339.99, score: 2.2 }, { maxTime: 349.99, score: 2.0 },
        { maxTime: 359.99, score: 1.8 }, { maxTime: 369.99, score: 1.6 }, { maxTime: 379.99, score: 1.4 },
        { maxTime: 389.99, score: 1.2 }, { maxTime: 399.99, score: 1.0 }, { maxTime: 409.99, score: 0.8 },
        { maxTime: 419.99, score: 0.6 }, { maxTime: 429.99, score: 0.4 }, { maxTime: 439.99, score: 0.2 },
        { maxTime: Infinity, score: 0.0 }
    ];

    const EVALUATION_CONFIGS = {
        'estabilizacao': { name: 'Prova de Estabilização Veicular', short_name: 'Estabilização', base_score: 1.5, penalties: ESTABILIZACAO_PENALTIES, penalty_deduction: 0.2, time_scores: TIME_SCORES_1_5, is_timed_score: true, is_corte: false, is_estabilizacao: true },
        'retirada': { name: 'Prova de Retirada de Vítimas', short_name: 'Retirada Vítimas', base_score: 3.0, penalties: COMMON_PENALTIES, penalty_deduction: 0.3, time_scores: TIME_SCORES_3_0, is_timed_score: true, is_corte: false, is_estabilizacao: false },
        'corte': { name: 'Prova de Técnica de Corte', short_name: 'Técnica Corte', base_score: 2.0, penalties: CORTE_SUBTYPE_PENALTIES, penalty_deduction: 0.1, time_scores: [], is_timed_score: false, is_corte: true, is_estabilizacao: false }
    };

    function getCurrentEvaluationConfig(type) {
        return EVALUATION_CONFIGS[type] || EVALUATION_CONFIGS['estabilizacao'];
    }

    function getFriendlySubtypeName(type, subtype) {
        if (!subtype) return '';
        if (type === 'estabilizacao') {
            return subtype === '4rodas' ? 'Sobre 04 Rodas' : 'Veículo Tombado';
        }
        if (type === 'corte') {
            return subtype === 'painel' ? 'Rebatimento de Painel' : 'Rebatimento Lateral de Teto';
        }
        return subtype;
    }

    // --- HELPERS ---
    function populateTimeSelectors() {
        const mins = document.getElementById('time-minutes');
        const secs = document.getElementById('time-seconds');
        if (!mins || !secs) return;
        mins.innerHTML = '';
        secs.innerHTML = '';
        for (let i = 0; i <= 15; i++) mins.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;
        for (let i = 0; i < 60; i++) secs.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;
    }

    function timeStringToObjects(timeStr) {
        if (!timeStr || !timeStr.includes(':')) return { minutes: 0, seconds: 0, milliseconds: 0 };
        const [m, rest] = timeStr.split(':');
        const [s, ms] = rest.split('.');
        return { minutes: parseInt(m) || 0, seconds: parseInt(s) || 0, milliseconds: parseInt(ms) || 0 };
    }

    function timeObjectToString(obj) {
        const m = String(obj.minutes || 0).padStart(2, '0');
        const s = String(obj.seconds || 0).padStart(2, '0');
        const ms = String(obj.milliseconds || 0).padStart(3, '0');
        return `${m}:${s}.${ms}`;
    }

    function getTimeBaseScore(seconds) {
        const type = document.getElementById('evaluation-type').value;
        const config = getCurrentEvaluationConfig(type);
        if (!config.is_timed_score) return config.base_score;
        const scoreItem = config.time_scores.find(t => seconds <= t.maxTime);
        return scoreItem ? scoreItem.score : 0.0;
    }

    function updatePrintData() {
        const container = document.getElementById('print-data-container');
        if (!container) return;
        
        const students = getStudentNamesFromForm();
        const instructors = getInstructorNamesFromForm();
        const type = document.getElementById('evaluation-type').value;
        const config = getCurrentEvaluationConfig(type);
        
        let sub = '';
        if (config.is_estabilizacao) sub = getFriendlySubtypeName(type, document.getElementById('estabilizacao-subtype-select').value);
        if (config.is_corte) sub = getFriendlySubtypeName(type, document.getElementById('corte-subtype-select').value);

        const curTime = {
            minutes: document.getElementById('time-minutes').value,
            seconds: document.getElementById('time-seconds').value,
            milliseconds: document.getElementById('time-milliseconds').value
        };

        container.innerHTML = `
            <h3 class="text-lg font-bold border-b-2 border-primary pb-1 mb-2 uppercase text-primary tracking-widest">Barema CFSd 2025</h3>
            <div class="grid grid-cols-2 gap-x-4 text-[10px] gap-y-1 font-medium">
                <p><b>Prova:</b> ${config.name}</p>
                <p><b>Cenário/Técnica:</b> ${sub || 'N/A'}</p>
                <p><b>Data:</b> ${new Date().toLocaleDateString('pt-BR')}</p>
                <p><b>Tempo:</b> ${config.is_timed_score ? timeObjectToString(curTime) : 'N/A (Nota Técnica)'}</p>
                <p class="col-span-2 border-t mt-1 pt-1"><b>Alunos Avaliados:</b> ${students.join(', ')}</p>
                <p class="col-span-2"><b>Avaliadores/Instrutores:</b> ${instructors.join(', ')}</p>
            </div>`;
    }

    // --- PERSISTÊNCIA ---
    function loadEvaluations() {
        const json = localStorage.getItem(LOCAL_STORAGE_KEY);
        const evaluations = json ? JSON.parse(json) : [];
        allStudentsInAllEvaluations = Array.from(new Set(evaluations.flatMap(e => e.studentNames || []))).sort();
        return evaluations;
    }

    function saveEvaluations(evaluations) {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(evaluations));
    }

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }

    // --- INPUTS DINÂMICOS ---
    function addStudentInput(name = '') {
        const container = document.getElementById('students-container');
        studentCount++;
        container.insertAdjacentHTML('beforeend', `
            <div id="st-${studentCount}" class="flex space-x-2">
                <input type="text" value="${name}" required placeholder="Nome do Aluno" oninput="handleStudentNameChange()" class="flex-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary student-name-input">
                <button type="button" onclick="this.parentElement.remove(); renderPenaltiesRegistration();" class="bg-red-500 text-white w-8 h-8 rounded-lg font-bold hover:bg-red-600">&times;</button>
            </div>
        `);
        renderPenaltiesRegistration();
    }

    function renderStudentInputs(namesArray) {
        const container = document.getElementById('students-container');
        container.innerHTML = '';
        if (namesArray && namesArray.length > 0) {
            namesArray.forEach(name => addStudentInput(name));
        } else {
            addStudentInput();
        }
    }

    function addInstructorInput(name = '') {
        const container = document.getElementById('instructors-container');
        instructorCount++;
        container.insertAdjacentHTML('beforeend', `
            <div id="inst-${instructorCount}" class="flex space-x-2">
                <input type="text" value="${name}" required placeholder="Avaliador" class="flex-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary instructor-name-input">
                <button type="button" onclick="this.parentElement.remove();" class="bg-red-500 text-white w-8 h-8 rounded-lg font-bold hover:bg-red-600">&times;</button>
            </div>
        `);
    }

    function renderInstructorInputs(namesArray) {
        const container = document.getElementById('instructors-container');
        container.innerHTML = '';
        if (namesArray && namesArray.length > 0) {
            namesArray.forEach(name => addInstructorInput(name));
        } else {
            addInstructorInput();
        }
    }

    function handleStudentNameChange() { renderPenaltiesRegistration(); }
    function getStudentNamesFromForm() { return Array.from(document.querySelectorAll('.student-name-input')).map(i => i.value.trim()).filter(v => v); }
    function getInstructorNamesFromForm() { return Array.from(document.querySelectorAll('.instructor-name-input')).map(i => i.value.trim()).filter(v => v); }

    // --- PENALIDADES ---
    window.applyPenalty = function(penaltyId) {
        const select = document.getElementById(`select-${penaltyId}`);
        const responsibleName = select.value;
        if (!responsibleName) return;
        if (!studentPenalties[responsibleName]) studentPenalties[responsibleName] = {};
        studentPenalties[responsibleName][penaltyId] = (studentPenalties[responsibleName][penaltyId] || 0) + 1;
        calculateScores();
        renderPenaltyBreakdown();
    }

    window.removePenalty = function(responsibleName, penaltyId) {
        if (studentPenalties[responsibleName]?.[penaltyId] > 0) {
            studentPenalties[responsibleName][penaltyId]--;
            if (studentPenalties[responsibleName][penaltyId] === 0) delete studentPenalties[responsibleName][penaltyId];
            calculateScores();
            renderPenaltyBreakdown();
        }
    }

    function renderPenaltyBreakdown() {
        const breakdownEl = document.getElementById('penalty-breakdown');
        breakdownEl.innerHTML = '';
        const currentType = document.getElementById('evaluation-type').value;
        const currentConfig = getCurrentEvaluationConfig(currentType);
        
        let penaltySource = currentConfig.penalties;
        if (currentConfig.is_corte) {
            const sub = document.getElementById('corte-subtype-select').value;
            penaltySource = currentConfig.penalties[sub];
        }

        for (const name in studentPenalties) {
            const isGroup = name === "Grupo";
            const colorClass = isGroup ? "text-primary border-primary bg-primary/5" : "text-indigo-700 border-indigo-300 bg-indigo-50/30";
            let html = `<li class="mt-2 font-bold p-1 border-l-4 ${colorClass} uppercase text-[9px] tracking-widest">${name}:</li><ul class="ml-4 space-y-1 border-l border-gray-100 pl-2">`;
            let hasPenalties = false;
            for (const pId in studentPenalties[name]) {
                const count = studentPenalties[name][pId];
                if (count > 0) {
                    const idx = parseInt(pId.split('-')[1]);
                    const pName = penaltySource[idx] || 'Penalidade';
                    html += `<li class="flex justify-between text-[10px] items-center text-gray-600 font-medium">${pName} <span class="bg-gray-200 px-2 rounded-full font-black text-gray-800 ml-2">x${count}</span> <button type="button" onclick="removePenalty('${name}', '${pId}')" class="bg-red-500 text-white px-2 ml-2 rounded no-print font-bold transform hover:scale-110">X</button></li>`;
                    hasPenalties = true;
                }
            }
            if (hasPenalties) breakdownEl.innerHTML += html + '</ul>';
        }
    }

    window.renderPenaltiesRegistration = function() {
        const container = document.getElementById('penalties-registration-list');
        const students = getStudentNamesFromForm();
        const type = document.getElementById('evaluation-type').value;
        const config = getCurrentEvaluationConfig(type);
        
        let list = config.penalties;
        if (config.is_corte) {
            const sub = document.getElementById('corte-subtype-select').value;
            list = config.penalties[sub];
        }
        
        PENALTIES = list.map((n, i) => ({ id: `p-${i}`, name: n }));

        container.innerHTML = PENALTIES.map(p => `
            <div class="border-b pb-2">
                <p class="text-[11px] font-semibold text-gray-700 mb-1 leading-tight">${p.name}</p>
                <div class="flex space-x-2">
                    <select id="select-${p.id}" class="flex-1 p-1 text-[10px] border rounded shadow-sm">
                        <option value="">-- Responsável --</option>
                        <option value="Grupo" class="font-bold text-primary italic">DEDUZIR DA EQUIPE INTEIRA</option>
                        ${students.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                    <button type="button" onclick="applyPenalty('${p.id}')" class="bg-primary text-white px-4 py-1 rounded text-xs font-bold hover:bg-red-700 transition">+</button>
                </div>
            </div>
        `).join('');
        calculateScores();
    }

    window.calculateScores = function() {
        const typeEl = document.getElementById('evaluation-type');
        if (!typeEl) return { scores: {}, timeStr: "00:00.000" };
        
        const type = typeEl.value;
        const config = getCurrentEvaluationConfig(type);
        const mins = parseInt(document.getElementById('time-minutes').value || 0);
        const secs = parseInt(document.getElementById('time-seconds').value || 0);
        const ms = parseInt(document.getElementById('time-milliseconds').value || 0);
        const totalSecs = (mins * 60) + secs + (ms / 1000);
        
        let baseScore = config.is_timed_score ? getTimeBaseScore(totalSecs) : config.base_score;
        document.getElementById('base-score').textContent = baseScore.toFixed(1);

        const students = getStudentNamesFromForm();
        const table = document.getElementById('individual-scores-table');
        table.innerHTML = '';
        const scores = {};
        
        let totalPenaltyCountAll = 0;
        for (const resp in studentPenalties) {
            for (const pid in studentPenalties[resp]) totalPenaltyCountAll += studentPenalties[resp][pid];
        }
        document.getElementById('penalty-count').textContent = totalPenaltyCountAll;

        const groupPenalties = studentPenalties["Grupo"] || {};
        let groupTotalDed = 0;
        for (const p in groupPenalties) groupTotalDed += groupPenalties[p];

        students.forEach(s => {
            let pCount = groupTotalDed;
            const studentList = studentPenalties[s] || {};
            for (const p in studentList) pCount += studentList[p];
            let final = Math.max(0, baseScore - (pCount * config.penalty_deduction));
            scores[s] = { finalScore: final, penaltyCount: pCount };
            
            const colorClass = final >= (config.base_score * 0.7) ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200';
            table.innerHTML += `
                <div class="flex justify-between items-center p-3 border rounded-lg ${colorClass} shadow-sm">
                    <span class="font-bold text-sm uppercase">${s}</span>
                    <div class="text-right">
                        <p class="text-[10px] uppercase font-bold opacity-75">Nota Final</p>
                        <span class="font-black text-2xl">${final.toFixed(1)}</span>
                    </div>
                </div>`;
        });
        
        updatePrintData();
        return { scores, timeStr: timeObjectToString({minutes: mins, seconds: secs, milliseconds: ms}) };
    }

    // --- FUNÇÃO PARA RENDERIZAR PENALIDADES EM RELATÓRIOS ---
    function renderPenaltyItemsList(evaluation, militarName = null) {
        const config = getCurrentEvaluationConfig(evaluation.type);
        let penaltySource = config.penalties;
        if (config.is_corte && evaluation.subtype) penaltySource = config.penalties[evaluation.subtype];
        
        let html = '<ul class="mt-2 space-y-1">';
        let hasContent = false;

        const group = evaluation.penalties["Grupo"];
        if (group) {
            for (const pId in group) {
                const idx = parseInt(pId.split('-')[1]);
                const name = penaltySource[idx] || "Item do barema";
                html += `<li class="text-[10px] text-gray-600"><span class="font-bold text-primary uppercase text-[8px]">[Equipe]</span> ${name} (${group[pId]}x)</li>`;
                hasContent = true;
            }
        }

        if (militarName && evaluation.penalties[militarName]) {
            const ind = evaluation.penalties[militarName];
            for (const pId in ind) {
                const idx = parseInt(pId.split('-')[1]);
                const name = penaltySource[idx] || "Item do barema";
                html += `<li class="text-[10px] text-gray-600"><span class="font-bold text-indigo-600 uppercase text-[8px]">[Individual]</span> ${name} (${ind[pId]}x)</li>`;
                hasContent = true;
            }
        } else if (!militarName) {
            for (const resp in evaluation.penalties) {
                if (resp === "Grupo") continue;
                const ind = evaluation.penalties[resp];
                for (const pId in ind) {
                    const idx = parseInt(pId.split('-')[1]);
                    const name = penaltySource[idx] || "Item do barema";
                    html += `<li class="text-[10px] text-gray-600"><span class="font-bold text-indigo-600 uppercase text-[8px]">[${resp}]</span> ${name} (${ind[pId]}x)</li>`;
                    hasContent = true;
                }
            }
        }

        if (!hasContent) return '<p class="text-[9px] text-green-600 italic">Desempenho limpo (sem ocorrências).</p>';
        return html + '</ul>';
    }

    // --- RELATÓRIOS ---
    window.showReportView = function(reportType) {
        document.getElementById('form-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('report-view').style.display = 'block';
        const container = document.getElementById('report-selection-container');
        const output = document.getElementById('student-report-output');
        output.innerHTML = '';

        if (reportType === 'individual') {
            document.getElementById('report-title').textContent = 'Relatório Individual Detalhado';
            container.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg border mb-4 shadow-inner">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-widest">Selecionar Militar:</label>
                    <select id="rep-stud" onchange="generateStudentReport()" class="w-full p-3 border rounded-lg shadow-sm font-bold text-gray-700">
                        <option value="">-- Selecione o Militar --</option>
                        ${allStudentsInAllEvaluations.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <button onclick="window.print()" class="w-full py-3 bg-blue-500 text-white rounded-lg mb-4 font-bold uppercase tracking-widest shadow-md hover:bg-blue-600 transition">Imprimir PDF Individual</button>`;
        } else {
            document.getElementById('report-title').textContent = 'Quadro Geral de Notas';
            container.innerHTML = `
                <button onclick="generateGlobalReport()" class="w-full py-4 bg-indigo-600 text-white rounded-lg mb-4 font-bold uppercase tracking-widest shadow-lg hover:bg-indigo-700 transition">Consolidar Dados</button>
                <button onclick="window.print()" class="w-full py-3 bg-blue-500 text-white rounded-lg mb-4 font-bold uppercase tracking-widest shadow-md hover:bg-blue-600 transition">Imprimir Relatório Geral</button>`;
        }
    }

    window.generateGlobalReport = function() {
        const evals = loadEvaluations();
        const scores = {};
        evals.forEach(e => {
            for (const name in e.individualScores) {
                if (!scores[name]) scores[name] = { total: 0, details: [] };
                scores[name].total += e.individualScores[name].finalScore;
                scores[name].details.push(e);
            }
        });

        let html = '<div class="space-y-4">';
        const sortedNames = Object.keys(scores).sort();
        
        sortedNames.forEach(name => {
            const safeName = name.replace(/'/g, "\\'");
            html += `
                <div class="border rounded-lg bg-white overflow-hidden shadow-sm border-gray-200">
                    <div class="flex justify-between items-center p-4 bg-gray-50 border-b">
                        <span class="font-bold text-gray-800 uppercase text-sm tracking-tight">${name}</span>
                        <div class="flex items-center space-x-4">
                            <span class="text-2xl font-black text-indigo-600">${scores[name].total.toFixed(1)}</span>
                            <button onclick="toggleGlobalDetails('${safeName}')" class="p-2 bg-gray-200 rounded-full no-print hover:bg-gray-300 transition">▼</button>
                        </div>
                    </div>
                    <div id="det-${safeName}" class="detail-row p-4 space-y-3 bg-gray-50/30">`;
            
            scores[name].details.forEach(ev => {
                const config = getCurrentEvaluationConfig(ev.type);
                const subFriendly = getFriendlySubtypeName(ev.type, ev.subtype);
                const sub = subFriendly ? ` - ${subFriendly}` : '';
                html += `
                    <div class="p-3 border rounded-lg bg-white shadow-inner">
                        <div class="flex justify-between border-b pb-1 mb-2">
                            <p class="font-bold text-indigo-800 uppercase text-[9px]">${config.name}${sub}</p>
                            <p class="text-[8px] text-gray-400 italic">${new Date(ev.updatedAt).toLocaleDateString()}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                            <p><b>Nota:</b> <span class="text-indigo-600 font-bold">${ev.individualScores[name].finalScore.toFixed(1)}</span></p>
                            <p><b>Tempo:</b> ${config.is_timed_score ? ev.time : 'Avaliação Técnica'}</p>
                        </div>
                        <div class="bg-gray-50 p-2 rounded border border-gray-100">
                            <p class="text-[8px] font-black uppercase text-gray-400 mb-1 tracking-widest">Ocorrências:</p>
                            ${renderPenaltyItemsList(ev, name)}
                        </div>
                        <p class="text-[8px] text-gray-400 mt-2 italic">Avaliadores: ${ev.instructorNames?.join(', ') || 'N/A'}</p>
                    </div>`;
            });
            html += '</div></div>';
        });
        document.getElementById('student-report-output').innerHTML = html + '</div>';
    }

    window.toggleGlobalDetails = function(id) {
        const el = document.getElementById(`det-${id}`);
        if (el) el.classList.toggle('open');
    }

    window.generateStudentReport = function() {
        const name = document.getElementById('rep-stud').value;
        if (!name) return;
        const evals = loadEvaluations().filter(e => e.studentNames.includes(name));
        let sum = 0;
        let html = `<h3 class="font-black text-center border-b-2 border-gray-100 pb-3 mb-4 uppercase text-gray-700 tracking-widest">Ficha de Desempenho: ${name}</h3><div class="space-y-4">`;
        
        evals.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

        evals.forEach(ev => {
            const config = getCurrentEvaluationConfig(ev.type);
            const score = ev.individualScores[name].finalScore;
            sum += score;
            const subFriendly = getFriendlySubtypeName(ev.type, ev.subtype);
            const sub = subFriendly ? ` - ${subFriendly}` : '';
            html += `
                <div class="p-4 border rounded-xl bg-gray-50 shadow-sm">
                    <div class="flex justify-between mb-2">
                        <p class="font-black text-indigo-700 uppercase text-xs">${config.name}${sub}</p>
                        <p class="text-[10px] font-bold text-gray-400">${new Date(ev.updatedAt).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div class="grid grid-cols-2 text-xs mt-1 gap-y-3 font-medium">
                        <div>
                            <p class="text-gray-400 uppercase text-[8px] font-black">Critério</p>
                            <p class="font-bold">${config.is_timed_score ? 'Tempo + Técnica' : 'Técnica Fixa'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-400 uppercase text-[8px] font-black">Nota Obtida</p>
                            <p class="text-xl font-black text-primary">${score.toFixed(1)}</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <p class="text-[8px] font-black uppercase text-gray-400 mb-1">Detalhamento Técnico:</p>
                        ${renderPenaltyItemsList(ev, name)}
                    </div>
                    <div class="text-[9px] text-gray-400 mt-3 flex justify-between italic bg-white p-1 rounded">
                        <span>Instrutores:</span>
                        <span class="font-bold text-gray-700 uppercase tracking-tighter">${ev.instructorNames?.join(', ') || 'N/A'}</span>
                    </div>
                </div>`;
        });
        
        document.getElementById('student-report-output').innerHTML = `
            <div class="bg-gradient-to-br from-indigo-600 to-blue-700 text-white p-6 rounded-2xl text-center mb-6 shadow-xl border-b-4 border-indigo-900">
                <p class="text-xs uppercase font-bold tracking-widest opacity-80 mb-1">Somatório Final CFSd</p>
                <p class="text-5xl font-black">${sum.toFixed(1)} <span class="text-xl opacity-75 font-normal">pts</span></p>
            </div>
            ${html}</div>`;
    }

    // --- NAVEGAÇÃO ---
    window.showList = function() {
        document.getElementById('form-view').style.display = 'none';
        document.getElementById('report-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'block';
        renderEvaluationsList();
    }

    window.showForm = function(ev = null) {
        const type = document.getElementById('evaluation-type-select').value;
        const config = getCurrentEvaluationConfig(type);
        document.getElementById('evaluation-type').value = type;
        document.getElementById('form-title').textContent = ev ? `Editar: ${config.short_name}` : `Nova: ${config.short_name}`;
        document.getElementById('evaluation-id').value = ev?.id || '';
        
        document.getElementById('estabilizacao-subtype-container').style.display = config.is_estabilizacao ? 'block' : 'none';
        document.getElementById('corte-subtype-container').style.display = config.is_corte ? 'block' : 'none';
        
        // NOVO: Oculta o tempo se a prova não for cronometrada (Corte)
        document.getElementById('time-selector-container').style.display = config.is_timed_score ? 'block' : 'none';

        studentPenalties = ev?.penalties || {};
        renderStudentInputs(ev?.studentNames || []);
        renderInstructorInputs(ev?.instructorNames || []);
        
        if (config.is_estabilizacao) document.getElementById('estabilizacao-subtype-select').value = ev?.subtype || '4rodas';
        if (config.is_corte) document.getElementById('corte-subtype-select').value = ev?.subtype || 'painel';

        const t = timeStringToObjects(ev?.time || '00:00.000');
        document.getElementById('time-minutes').value = t.minutes;
        document.getElementById('time-seconds').value = t.seconds;
        document.getElementById('time-milliseconds').value = t.milliseconds;

        document.getElementById('list-view').style.display = 'none';
        document.getElementById('form-view').style.display = 'block';
        renderPenaltiesRegistration();
    }

    window.exportToCSV = function() {
        const evals = loadEvaluations();
        if (!evals.length) return;
        let csv = 'Data;Prova;Cenario;Alunos;Avaliadores;Tempo;NotaMin;NotaMax\n';
        evals.forEach(e => {
            const sub = getFriendlySubtypeName(e.type, e.subtype);
            const scoreValues = Object.values(e.individualScores).map(s => s.finalScore);
            const min = Math.min(...scoreValues).toFixed(1);
            const max = Math.max(...scoreValues).toFixed(1);
            csv += `${new Date(e.updatedAt).toLocaleDateString('pt-BR')};${e.type};${sub};"${e.studentNames.join(', ')}";"${e.instructorNames.join(', ')}";${e.time};${min};${max}\n`;
        });
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `relatorio_cfsd_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.csv`;
        link.click();
    }

    document.getElementById('evaluation-form').onsubmit = function(e) {
        e.preventDefault();
        try {
            const data = calculateScores();
            const id = document.getElementById('evaluation-id').value;
            const type = document.getElementById('evaluation-type').value;
            const config = getCurrentEvaluationConfig(type);
            
            let subtype = undefined;
            if (config.is_corte) subtype = document.getElementById('corte-subtype-select').value;
            if (config.is_estabilizacao) subtype = document.getElementById('estabilizacao-subtype-select').value;

            const newEval = {
                id: id || generateId(),
                type,
                subtype,
                studentNames: getStudentNamesFromForm(),
                instructorNames: getInstructorNamesFromForm(),
                time: config.is_timed_score ? data.timeStr : "N/A (Técnica)",
                penalties: JSON.parse(JSON.stringify(studentPenalties)),
                individualScores: data.scores,
                updatedAt: new Date().toISOString()
            };

            let evals = loadEvaluations();
            if (id) {
                const idx = evals.findIndex(i => i.id === id);
                if (idx !== -1) evals[idx] = newEval;
                else evals.push(newEval);
            } else {
                evals.push(newEval);
            }
            saveEvaluations(evals);
            showList();
        } catch (error) {
            console.error("Erro ao salvar:", error);
            alert("Erro ao processar dados.");
        }
    }

    window.renderEvaluationsList = function() {
        const select = document.getElementById('evaluation-type-select');
        if (!select) return;
        
        const type = select.value;
        const evals = loadEvaluations().filter(e => (e.type || 'estabilizacao') === type);
        const container = document.getElementById('evaluations-list');
        const empty = document.getElementById('list-empty');
        container.innerHTML = '';
        
        if (evals.length === 0) {
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';

        evals.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

        evals.forEach(ev => {
            const config = getCurrentEvaluationConfig(ev.type);
            const subFriendly = getFriendlySubtypeName(ev.type, ev.subtype);
            const scoreValues = Object.values(ev.individualScores).map(s => s.finalScore);
            const min = Math.min(...scoreValues).toFixed(1);
            const max = Math.max(...scoreValues).toFixed(1);
            const scoreRange = min === max ? min : `${min} - ${max}`;
            
            container.innerHTML += `
                <div class="p-4 border border-gray-200 rounded-xl bg-white flex justify-between items-center shadow-sm hover:border-primary/30 transition">
                    <div class="flex-1 pr-4">
                        <p class="text-[10px] text-primary font-black uppercase tracking-widest mb-1">${subFriendly || 'Geral'}</p>
                        <p class="font-black text-gray-800 text-sm uppercase leading-tight">${ev.studentNames[0]}${ev.studentNames.length > 1 ? ' + equipe' : ''}</p>
                        <div class="flex items-center text-[9px] text-gray-400 mt-2 space-x-2">
                            <span class="bg-gray-100 px-1 rounded font-bold">${config.is_timed_score ? ev.time : 'Nota Técnica'}</span>
                            <span>•</span>
                            <span class="italic">Instrutor: ${ev.instructorNames?.[0] || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="text-right">
                            <p class="text-[8px] uppercase font-black text-gray-400 tracking-tighter">Nota(s)</p>
                            <span class="text-lg font-black text-indigo-600">${scoreRange}</span>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <button onclick='showForm(${JSON.stringify(ev)})' class="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-secondary hover:text-white transition shadow-sm">✎</button>
                            <button onclick='deleteEvaluationInList("${ev.id}")' class="p-2 bg-gray-100 text-gray-400 rounded-lg hover:bg-red-500 hover:text-white transition shadow-sm">✕</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    window.deleteEvaluationInList = function(id) {
        if (!confirm('Deseja excluir permanentemente este registro?')) return;
        let evals = loadEvaluations();
        evals = evals.filter(e => e.id !== id);
        saveEvaluations(evals);
        renderEvaluationsList();
    }

    window.triggerPrint = function() { window.print(); }
    
    function initializeApp() {
        populateTimeSelectors();
        renderEvaluationsList();
        document.getElementById('main-content').style.display = 'block';
    }

    window.onload = initializeApp;
</script>

</body>
</html>